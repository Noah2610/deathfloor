#!/bin/bash
# Builds the docker images used by cross.

set -e

# shellcheck source=./share.sh disable=SC2155
_dir="$( dirname "$( realpath "$0" )" )"
source "${_dir}/share.sh"
unset _dir

check "docker"
check "dirname"

DOCKERFILE_PREFIX="${ROOT}/cross-build/Dockerfile."
IMAGE_TAG_PREFIX="cross-build-"
BUILD_TARGETS=( \
    "linux" \
    "windows" \
)

function main {
    local CLRCODE="$( clr "${CLR_CODE[@]}" )"
    local CLRRS="$( clrrs )"

    local target=
    local target_display=
    local dockerfile=
    local context_dir=
    local image_tag=

    for target in "${BUILD_TARGETS[@]}"; do
        target_display="${CLRCODE}${target}${CLRRS}"
        msg "Building image for target ${target_display}"

        dockerfile="${DOCKERFILE_PREFIX}${target}"
        context_dir="$( dirname "$dockerfile" )"
        image_tag="${IMAGE_TAG_PREFIX}${target}"

        check_file "$dockerfile"
        check_dir "$context_dir"

        try_run \
            docker build \
                -t "$image_tag" \
                -f "$dockerfile" \
                "$context_dir"

        msg "Built image for target ${target_display} with tag ${CLRCODE}${image_tag}${CLRRS}"
    done
}

main "$@"
