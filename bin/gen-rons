#!/bin/bash
# Generate spritesheet RON config files using `sprongen`.
# Any arguments are passed to the underlying `sprongen` command.

# shellcheck source=./util.sh
_dir="$( dirname "$0" )"
[ -f "${_dir}/util.sh" ] || bash "${_dir}/download-util.sh" || exit 1
source "${_dir}/util.sh"
unset _dir

SPRITESHEETS_DIR="${ROOT}/resources/spritesheets/tiles"
TILE_SIZE="8x8"
MIN_SPRONGEN_VERSION="0.0.2"

check "cargo"

# https://stackoverflow.com/a/4024263/10927893
version_ge() {
    [  "$1" = "$( echo -e "$1\n$2" | sort -Vr | head -n1 )" ]
}

function main {
    check_dir "$SPRITESHEETS_DIR"
    check_installed_sprongen

    local args
    args=( \
        --amethyst-version "master" \
        --tile-size "$TILE_SIZE" \
        "$@" \
    )

    msg "Generating RON config files for PNG spritesheets in
    $( colored "$COLOR_CODE" "$SPRITESHEETS_DIR" )"
    also_to_stderr=1 try_run \
        "sprongen ${SPRITESHEETS_DIR}/*.png ${args[*]}"
}

function check_installed_sprongen {
    (is_available "sprongen" \
        && version_ge \
            "$( sprongen --version | cut -d" " -f2 )" \
            "$MIN_SPRONGEN_VERSION" ) \
        || err_sprongen_not_installed
}

function err_sprongen_not_installed {
    local input
    local errmsg
    errmsg="\
$( colored "$COLOR_ERR" "Error:" ) $( colored "$COLOR_CODE" "sprongen" ) CLI app is not installed or is out-dated.
Install automatically with $( colored "$COLOR_CODE" "cargo" )? [y|N] "

    while [ -z "$input" ]; do
        echo -en "$errmsg"
        read -r input
        case "${input:0:1}" in
            ""|"n"|"N")
                exit 0
                ;;
            "y"|"Y")
                also_to_stderr=1 try_run \
                    "cargo --color always install sprongen --version ${MIN_SPRONGEN_VERSION} --force"
                ;;
            *)
                input=
                ;;
        esac
    done
}

main "$@"
