#!/bin/bash
# Generate spritesheet RON config files using `sprongen`.
# Any arguments are passed to the underlying `sprongen` command.

# shellcheck source=./util.sh
_dir="$( dirname "$0" )"
[ -f "${_dir}/util.sh" ] || bash "${_dir}/download-util.sh" || exit 1
source "${_dir}/util.sh"
unset _dir

SPRITESHEETS_DIR="${ROOT}/resources/spritesheets/tiles"
TILE_SIZE="16x16"

check "cargo"

function main {
    check_dir "$SPRITESHEETS_DIR"
    check_installed_sprongen

    local args
    args=( --tile-size "$TILE_SIZE" "$@" )

    msg "Generating RON config files for PNG spritesheets in
    $( colored "$COLOR_CODE" "$SPRITESHEETS_DIR" )"
    also_to_stderr=1 try_run \
        "sprongen ${SPRITESHEETS_DIR}/*.png ${args[*]}"
}

function check_installed_sprongen {
    is_available "sprongen" || err_sprongen_not_installed
}

function err_sprongen_not_installed {
    local input
    local errmsg
    errmsg="\
$( colored "$COLOR_ERR" "Error:" ) $( colored "$COLOR_CODE" "sprongen" ) CLI app is not installed.
Install automatically with $( colored "$COLOR_CODE" "cargo" )? [y|N] "

    while [ -z "$input" ]; do
        echo -en "$errmsg"
        read -r input
        case "${input:0:1}" in
            ""|"n"|"N")
                exit 0
                ;;
            "y"|"Y")
                also_to_stderr=1 try_run \
                    "cargo --color always install sprongen"
                ;;
            *)
                input=
                ;;
        esac
    done
}

main "$@"
